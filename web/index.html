<!doctype html>
<html lang="en">

<head>
    <!-- required meta -->
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="keywords" content="boot, Bootstrap, MSN Sale">
    <meta name="description" content="MSN Sale">
    <title>MSN Sale</title>
    <link rel="shortcut icon" href="assets/images/icon/meson.jpeg" type="image/x-icon">
    <link rel="stylesheet" href="assets/css/style.min.css">
    <link rel="stylesheet" href="assets/css/main.css">

</head>

<body>
 
    <header class="header-section header-menu w-100 pt-lg-0 pb-3 pb-lg-0">
        <div class="navbar_mainhead header-fixed w-100">
            <div class="container">
                <div class="row align-items-center">
                    <div class="col-12">
                        <nav class="navbar navbar-expand-lg position-relative workready" style="display: flex !important; justify-content: space-between !important; align-items: center !important;">
                            <a class="navbar-brand d-flex align-items-center gap-2">
                                <img src="assets/images/icon/meson.jpeg" width="64px" style="border-radius: 30%;" class="logo" alt="logo">
                            </a>

                            <div class="collapse navbar-collapse justify-content-between" id="navbar-content">
                                <ul
                                    class="navbar-nav d-flex align-items-lg-center gap-5 gap-lg-1 gap-xl-4 gap-xxl-7 py-2 py-lg-0 ms-2 ms-xl-10 ms-xxl-20 ps-0 ps-xxl-10 align-self-center">
                                    <li class="dropdown">
                                        <a class="fs-ten">Home</a>
                                    </li>
                                    <li class="dropdown show-dropdown">
                                        <button type="button" aria-label="Navbar Dropdown Button"
                                            class="dropdown-toggle dropdown-nav d-flex align-items-center fs-ten">Staking
                                            <i class="ti ti-chevron-down"></i></button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item fs-ten" href="">Staking Pool</a>
                                            </li>
                                            <li><a class="dropdown-item fs-ten" href="">Pool
                                                    details</a></li>
                                        </ul>
                                    </li>
                                    <li class="dropdown show-dropdown">
                                        <button type="button" aria-label="Navbar Dropdown Button"
                                            class="dropdown-toggle dropdown-nav d-flex align-items-center fs-ten">IDO <i
                                                class="ti ti-chevron-down"></i></button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item fs-ten" href="">IDO</a></li>
                                            <li><a class="dropdown-item fs-ten" href="">IDO Details</a>
                                            </li>
                                        </ul>
                                    </li>
                                    <li class="dropdown show-dropdown">
                                        <button type="button" aria-label="Navbar Dropdown Button"
                                            class="dropdown-toggle dropdown-nav d-flex align-items-center fs-ten">Swap
                                            <i class="ti ti-chevron-down"></i></button>
                                        <ul class="dropdown-menu">
                                            <li><a class="dropdown-item fs-ten" href="">Swap</a></li>
                                            <li><a class="dropdown-item fs-ten" href="">Swap to
                                                    share</a></li>
                                        </ul>
                                    </li>
                                </ul>
                            </div>


                            <div class="right-area custom-pos position-relative align-items-center">

                                <div class="header-section__modalstyle">
                                    <!-- Button trigger modal -->
                                    <button type="button"
                                        class="cmn-btn px-3 px-sm-5 py-2 d-flex align-items-center gap-1" id="metamask_connect_btn">

                                        <img src="assets/images/icon/metamask.png" height="25px" alt=""> &nbsp;

                                        <span class="p7-color fw-semibold" id="wallet_text">Connect Wallet</span>
                                        
                                        <div class="loading-ring d-none"></div>

                                    </button>
                                </div>

                            </div>

                        </nav>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- header-section end -->
    <!-- Buy Crypto Section Starts Starts -->
    <section class="buy_crypto pt-120 pb-120">
        <div class="container pt-17 pt-sm-20 pt-lg-0">
            <div class="row align-items-center">
                <div class="col-xl-6">
                    <div class="buy_crypto__effort">
                        <h2 class="mb-10 mb-md-15 wow fadeInUp">Buy MSN</h2>
                        
                        <div
                            class="buy_crypto__item d-flex align-items-center flex-wrap flex-sm-nowrap gap-4 gap-sm-5 gap-md-6 mb-10 mb-md-15 wow fadeInUp">
                            <div class="buy_crypto__item-thumb">
                                <img src="assets/images/icon/convenient.png" class="max-un" alt="Icons">
                            </div>
                            <div class="buy_crypto__item-content">
                                <h4 class="mb-5">Convenient</h4>
                                <p>Choose from a wide range of payment options to buy MSN the way you prefer.</p>
                            </div>
                        </div>
                        <div
                            class="buy_crypto__item d-flex align-items-center flex-wrap flex-sm-nowrap gap-4 gap-sm-5 gap-md-6 mb-10 mb-md-15 wow fadeInUp">
                            <div class="buy_crypto__item-thumb">
                                <img src="assets/images/icon/low-cost.png" class="max-un" alt="Icons">
                            </div>
                            <div class="buy_crypto__item-content">
                                <h4 class="mb-5">Low-cost</h4>
                                <p><b>Price : </b>1 USDT = 20000 MSN</p>
                                <p><b>Minimum Buy : </b>0.00005 USDT = 1 MSN</p>
                            </div>
                        </div>
                        <div
                            class="buy_crypto__item d-flex align-items-center flex-wrap flex-sm-nowrap gap-4 gap-sm-5 gap-md-6 mb-10 mb-md-15 wow fadeInUp">
                            <div class="buy_crypto__item-thumb">
                                <img src="assets/images/icon/accessible.png" class="max-un" alt="Icons">
                            </div>
                            <div class="buy_crypto__item-content">
                                <h4 class="mb-5">Accessible</h4>
                                <p><b>Network : </b>Sepolia Testnet</p>
                                <p><b>Contrace address : </b><p>0x55d398326f99059fF775485246999027B3197955</p></p>
                            </div>
                        </div>

                    </div>
                </div>
                <div class="col-xl-6">
                    <div class="buy_crypto__formarea p-6 p-px-8 rounded-20 bg7-color wow fadeInUp">
                        <h2 class="mb-3">Buy Crypto</h2>
                        <span class="mb-8 mb-md-10">Buy In Seconds</span>
                        <form id="buy_form">
                            <div class="buy_crypto__formarea-group mb-5 mb-md-6">
                                <label class="mb-2">Spend</label>
                                <div class="d-flex align-items-center br2 p-1 rounded-4 bg1-color">
                                    <input type="text" value="1" placeholder="Enter purchase amount" id="usdt_amount">
                                    <div class="text-end">
                                        <div class="apex_section__slider-selector markets_section__rcard-selector">
                                            <div class="f-group">
                                                <select style="background-color: #bce70c;" id="select3" class="f-control">
                                                        <option value="usdt" selected class="set_bnb_usdt_options">
                                                        USDT</option>
                                                        <option value="bnb"  class="set_bnb_usdt_options">
                                                        BNB</option>
                                                </select>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div> 
                            <div class="buy_crypto__formarea-group mb-2 mb-md-2">
                                <label class="mb-2">Receive</label>
                                <div class="d-flex align-items-center br2 p-1 rounded-4 mb-2 bg1-color">
                                    <input type="text" placeholder="Enter purchase amount" value="20000" id="msn_amount">
                                    <div class="text-end">
                                        <div class="apex_section__slider-selector markets_section__rcard-selector">
                                            <div class="" style="padding: 5px 10px; display: flex; justify-content: center; align-items: center;">
                                                <img width="30px" style="border-radius: 50%;" src="assets/images/icon/meson.jpeg" alt="">
                                                &nbsp;&nbsp;
                                                <span style="font-family: 'Lexend', sans-serif;">MSN</span>
                                                &nbsp;&nbsp;
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <span>1 USDT = 20000 MSN</span>
                            </div>
                            <div class="buy_crypto__formarea-group mb-5 mb-md-6">
                                <div class="mb-2 rounded-4">
                                    <div class="" style="display: flex; align-items: center;">
                                        <span>Network : </span> &nbsp;&nbsp;&nbsp;
                                        <img style="height: 30px !important;" src="assets/images/icon/bnb.png" alt="">
                                    </div>
                                </div>
                                <div class="d-flex justify-content-between">
                                    <span>Minimum Buy</span>
                                    <span class="p1-color">0.00005 USDT</span>
                                </div>
                            </div>
                            <a id="buy_btn" class="cmn-btn py-3 px-5 px-md-6 d-block">
                                <button type="submit" style="width: 100%; height: 100%; display: flex; justify-content: center; align-content: center;"><span style="color: black; font-weight: bold;" class="buy_btn_text">Buy</span><div class="buy-loading-ring d-none"></div> </button>
                            </a>
                        </form>
                    </div>
                </div>
            </div>
            <br>
            <div class="row error_box"> </div>
        </div>
    </section>
    <!-- Buy Crypto Section Starts Ends -->

    <!-- refferal user  -->
        <section class="pools_table pt-120 pb-120">
            <div class="container">
                <div class="row">
                    <div class="pools_table__title mb-5 mb-md-6">
                        <h2 class="mb-5 mb-md-6 wow fadeInUp">Refferal</h2>
                        <p class="roboto wow fadeInUp">
                            <b>Refferal Link: &nbsp; &nbsp;</b><span class="refferal_input">0xC493ab45Dec7d3a98297D6d16f4614277D7B3BB6</span>
                            &nbsp;&nbsp;
                            <button class="reffer_copy_btn cmn-btn mt-md-3" style="padding: 3px 10px; color: black; font-weight: 100; background-color:#bce70c;">Copy</button>
                        </p>
                        <script>
                          document.querySelector('.reffer_copy_btn')
                          .addEventListener('click',function(){
                             navigator.clipboard.writeText(document.querySelector('.refferal_input').value);
                          });
                        </script>
                    </div>

                    <div>
                        <div class="refferal_div_heading">
                            <div><h5><b>#</b></h5></div>
                            <div><h5><b>User Address</b></h5></div>
                            <div><h5><b>Minimum Buy</b></h5></div>
                        </div>
                        <div class="refferal_div_body">
                            <div class="row_body">
                                <div><b>1</b></div>
                                <div style="color:#BCE70C;">0xC493...B3BB6</div>
                                <div class="reffer_mini_btn"><button class="pending">Pending</button></div>
                            </div>
                            <div class="row_body">
                                <div><b>2</b></div>
                                <div style="color:#BCE70C;">0xC493...B3BB6</div>
                                <div class="reffer_mini_btn"><button class="pending">Pending</button></div>
                            </div>
                            <div class="row_body">
                                <div><b>3</b></div>
                                <div style="color:#BCE70C;">0xC493...B3BB6</div>
                                <div class="reffer_mini_btn"><button class="success">Complete</button></div>
                            </div>
                        </div>
                    </div>


                </div>
            </div>
        </section>
    <!-- refferal user  -->

    <!-- notification start -->
    <div id="notification" class="notification">
      <span class="close">&times;</span>
      <p id="notification_text"></p>
    </div>
    <!-- notification end  -->

    <div></div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.5.3/dist/web3.min.js"></script>
    
    <!-- <script src="https://cdn.ethers.io/scripts/ethers-v4.min.js"
        charset="utf-8"
        type="text/javascript">
    </script> -->

    <script src="assets/js/ethers.js"></script>

</body>
</html>

<script src="assets/js/000_abi.js"></script>

<script>
    window.onload = () => {
        const divs = document.querySelectorAll('div'); // Select all div elements
        const lastDiv = divs[divs.length - 1]; // Access the last div element
        lastDiv.style.display = 'none';
    };

</script>

<script>

window.onload = () =>{


    try {

        // =============================================================================
        // ================== all variables ============================================
        // =============================================================================

        let usdt_input = document.querySelector('#usdt_amount');
        let msn_input = document.querySelector('#msn_amount');
        let buy_btn = document.querySelector('#buy_btn');
        let metamask_connect_btn = document.querySelector('#metamask_connect_btn');
        let noti_close = document.querySelector('.close');

        let buy_btn_text = document.querySelector('.buy_btn_text');
        let buy_loading_ring = document.querySelector('.buy-loading-ring');

        let bnb_usdt_op = document.querySelector('#select3');

        let wallet_text = document.querySelector('#wallet_text');
        let connection_ring = document.querySelector('.loading-ring');


        //contract variables
        const toAddress = '0xC493ab45Dec7d3a98297D6d16f4614277D7B3BB6'; // bnb sending to address
        const bnb_endpoint = 'https://data-seed-prebsc-1-s1.binance.org:8545/'; // tx check bnb endpoint


        // token details variables
        let user_wallet_address = '';
        let bnb_usdt = 0;
        let per_usdt_msn = 20000;

        //chain details
        const chainId = '0x61'; // Chain ID for BSC
        const chainName = 'BNB Smart Chain Testnet';
        const chain_add_rpcUrl ='https://endpoints.omniatech.io/v1/bsc/testnet/public	'; // RPC URL for BSC
        const symbol = 'BNB';
        const blockExplorerUrl = 'https://bscscan.com/'; // Block explorer URL for BSC


        // ============== notification and loading function =============
        const web_url_catch = window.location.search;
        const urlParams = new URLSearchParams(web_url_catch);
        const user_telegram_id = urlParams.get('user');
        const refferal_id = urlParams.get('id') != '' && urlParams.get('id') != null? urlParams.get('id'): 00;

                // set web3 object
                if (typeof window.ethereum !== 'undefined') {
                    window.web3 = new Web3(window.ethereum);
                }

                // ========= set provider ===============
                const provider = new ethers.providers.JsonRpcProvider('https://eth-sepolia.g.alchemy.com/v2/b1qu65NnDmm0ngvQY49HrF2aD2_oD5ih');

                const wallet = new ethers.Wallet('9936ffd8c463b8e12018c8d441932b942e7467be27a9cdf4086a7b5c15c0706d', provider,);

                const tokenAddress = '0x5bcEFBe7994426b5c3426192b376f83032b7bBef';

                let contract = new ethers.Contract(tokenAddress, tokenAbi, wallet);

                // ================================== =============================

                async function fetchBNBPriceInUSDT() {
                try {
                    const response = await fetch('https://api.binance.com/api/v3/ticker/price?symbol=BNBUSDT',);
                    const data = await response.json();
                    const bnbPriceInUSDT = parseFloat(data.price);
                    bnb_usdt = bnbPriceInUSDT;
                } catch (error) {
                    console.error('Error fetching BNB price:', error);
                    throw error;
                }
                }
                
                setTimeout(() => {fetchBNBPriceInUSDT();}, 1000);
                
                // =========================== set msn price function ====================
                function set_msn_input() {
                if (bnb_usdt_op.value == 'usdt') {
                    msn_input.value = usdt_input.value * per_usdt_msn;
                } else {
                    msn_input.value = usdt_input.value * bnb_usdt * per_usdt_msn;
                }
                }
                
                function set_bnb_usdt_input() {
                if (bnb_usdt_op.value == 'usdt') {
                    usdt_input.value = msn_input.value / per_usdt_msn;
                } else {
                    usdt_input.value = msn_input.value / per_usdt_msn / bnb_usdt;
                }
                }
                // =========================== set msn price function ====================
                
                //  ============= set msn price calling======================
                usdt_input.addEventListener('input', function () {
                set_msn_input();
                });
                
                msn_input.addEventListener('input', function () {
                set_bnb_usdt_input();
                });
                
                bnb_usdt_op.addEventListener('change', function () {
                set_msn_input();
                });

                // ==================== check bnb tx ==========================

                async function check_tx(tx,mss_amount){
                    let txhash = tx.transactionHash;
                    let admin_address = tx.to;

                    const bscProvider = new ethers.providers.JsonRpcProvider(bnb_endpoint);
                    bscProvider.getTransaction(txhash)
                    .then(async (transaction) => {
                        if (transaction == null || transaction == undefined ||transaction == '') {
                            alert('accepct only bnb on bnb chain');
                        } else {
                            if (admin_address.toString().toLowerCase() == toAddress.toLowerCase()) {
                                document.querySelector('.error_box').innerHTML = `<i style="color:red; padding:5px; background-color:white;">If you've successfully completed your transaction but haven't received the MSN token, please contact us via Telegram at @taritmahato</i>`;

                                await purchase_complete(tx, mss_amount);

                            }
                        }

                    })
                    .catch((error) => {
                        console.error('Error fetching transaction:', error);
                    });

                }


                // ================ filter response =============== 
                async function get_response(receipt) {
                    const event = receipt.events.find((event) => event.event === 'response');
                    const status = event.args.status;
                    const message = event.args.message;
                    const txhash = receipt.hash;

                    if (status) {
                        return [status, txhash, message];
                    } else {
                        return [status, txhash, message];
                    }
                }

                // notification ufnction 
                let notification_text = document.querySelector('#notification_text');
                var notification = document.getElementById('notification');

                function showNotification(text, color, background) {

                notification_text.innerText = text;
                notification_text.style.color = color;
                notification.style.backgroundColor = background;
                notification.classList.add('show');

                setTimeout(function () {
                    hideNotification();
                    notification_text.innerText = "";
                }, 1000 * 5); // Hide after 10 seconds
                }

                function hideNotification() {
                    notification.classList.remove('show');
                    notification_text.innerText = '';
                }

                noti_close.addEventListener('click', function () {
                    hideNotification();
                });


                function buy_loading(action){
                    if(action == 'start'){
                        buy_btn_text.innerText = '';
                        buy_loading_ring.classList.remove('d-none');
                    }else{
                        buy_btn_text.innerText = 'Buy';
                        buy_loading_ring.classList.add('d-none');
                    }
                }

                // =================== interect with blok chain functions ===============
                // register user 
                async function registerUser(address, userTelegramId, referralId) {
                    if (userTelegramId != null && userTelegramId != '') {
                        try {
                            const userAdding_tx = await contract.registerUser( address, userTelegramId, referralId,);
                            let userAddingStatus = await userAdding_tx.wait();
                            let response_r_u = await get_response(userAddingStatus);

                            console.log(response_r_u);
                        } catch (error) {
                            console.log(error);
                            console.error('Error registering user:', error);
                        }
                    }
                }

                // change user minimum buy status
                async function minimum_buy_complete(_minimum_buy_wallet_address) {
                    if ( _minimum_buy_wallet_address != null && _minimum_buy_wallet_address != '') {
                        try {
                            const userminimum_tx = await contract.mini_buy_status_change(
                                _minimum_buy_wallet_address,
                            );
                            let userminimum_buy_Status = await userminimum_tx.wait();
                            let response_m_b_c = await get_response(userminimum_buy_Status);

                            console.log(response_m_b_c);
                            } catch (error) {
                            console.error('Error registering user:', error);
                            }
                    }
                }


                // send msn to user 
                async function purchase_complete(tx, sending_token_amount) {
                    let userAddress = tx.from;
                    const amountToSend = ethers.utils.parseUnits(sending_token_amount.toString(),18,);

                    try {
                        const tx = await contract.transfer(userAddress, amountToSend);
                        showNotification(`ðŸŽ‰ You bought ${sending_token_amount} MSN ðŸŽ‰`,'green','#b0ffb0',);
                        buy_loading('end');

                        await minimum_buy_complete(userAddress);
                    } catch (error) {
                        buy_loading('end');
                        showNotification(`If you've successfully completed your transaction but haven't received the MSN token, please contact us via Telegram at @taritmahato`,'red','#ffb0b0',);
                    }
                }


                // ============================== connect metamask ===========================
                async function connect_metamask() {

                    if (typeof window.ethereum !== 'undefined') {
                        connection_ring.classList.remove('d-none');
                        wallet_text.innerText = '';

                        window.ethereum.request({ method: 'eth_requestAccounts' })
                        .then(async function (accounts) {
                            const account = accounts[0];
                            user_wallet_address = account;
                            connection_ring.classList.add('d-none');

                            const firstFour_cha = account.substring(0, 4);
                            const lastFour_cha = account.slice(-4);
                            wallet_text.innerText = firstFour_cha + '...' + lastFour_cha;

                            showNotification('Wallet connect success', 'green', '#b0ffb0');

                            registerUser(account, user_telegram_id, refferal_id);
                            return account;
                        })

                        .catch(function (error) {
                            showNotification('Wallet Connect Failed', 'red', '#ffb0b0'); //error
                            connection_ring.classList.add('d-none');
                            wallet_text.innerText = 'Connect wallet';
                        });

                    } else {
                        connection_ring.classList.add('d-none');
                        wallet_text.innerText = 'Connect wallet';
                        window.location.herf = 'https://metamask.io/download/';
                    }
                
                }

                
            // =============================== add bnb chain and switch to bnb network ===============
                async function addBSCNetwork() {
                    try {
                        // Request MetaMask to add the BSC network
                        await ethereum.request({
                        method: 'wallet_addEthereumChain',
                        params: [
                            {
                            chainId: chainId,
                            chainName: chainName,
                            rpcUrls: [chain_add_rpcUrl],
                            nativeCurrency: {
                                name: symbol,
                                symbol: symbol,
                                decimals: 18,
                            },
                            blockExplorerUrls: [blockExplorerUrl],
                            },
                        ],
                        });

                        return true;
                    } catch (error) {
                        console.error(
                        'Error adding Binance Smart Chain network to MetaMask:',
                        error,
                        );
                    }
                }

                async function switchToBSCNetwork() {

                    try {
                        // Request MetaMask to switch to the BSC network
                        await ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: chainId }],
                        });

                        return true;
                    } catch (error) {

                        if (error.code === 4001) {
                        await switchToBSCNetwork();
                        }

                        if (error.code === 4902) {
                        await addBSCNetwork();
                        }

                        return false;
                    }
                }

                async function catch_connect_request(){
                    await connect_metamask();

                    let switching_chain_id_status = await switchToBSCNetwork();
                }

                metamask_connect_btn.addEventListener('click', function () {
                    catch_connect_request();
                });


                // ======================== buy function  =====================================
                async function send_request_to_buy() {
                    await  buy_loading('start');

                    const gasPrice_bnb = await window.web3.eth.getGasPrice();
                    const gasLimit_bnb = '22000';

                    let msn_buy_amount = msn_input.value;
                    let bnb_usdt_price = bnb_usdt;

                    let buy_amount = usdt_input.value.toString();
                    if (bnb_usdt_op.value == 'usdt') {
                        buy_amount = (1 / bnb_usdt_price).toFixed(9).toString();
                    }

                    const transactionObject = {
                        from: user_wallet_address,
                        to: toAddress,
                        value: window.web3.utils.toWei(buy_amount, 'ether'),
                        gasLimit: gasLimit_bnb,
                        gasPrice: gasPrice_bnb,
                    };

                    try {

                        let tx_1 = await window.web3.eth.sendTransaction(transactionObject);
                        showNotification('Transction Success', 'green', '#b0ffb0'); //success

                        let check_tx_status = await check_tx(tx_1, msn_buy_amount);

                    } catch (error) {
                        buy_loading('end');
                        return false;
                    }
                }

                let buy_form = document.querySelector('#buy_form');

                buy_form.addEventListener('submit', async function (e) {
                e.preventDefault();

                    if (user_wallet_address == '' || user_wallet_address == null) {
                        await catch_connect_request();
                        await send_request_to_buy();
                        return false;
                    } else {
                        await send_request_to_buy();
                    }

                });


    } catch (error) {
        buy_loading('end');
        console.log(error);    
    }

}
</script>
